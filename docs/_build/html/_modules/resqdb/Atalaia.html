
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>resqdb.Atalaia &#8212; RES-Q package January, 2019 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for resqdb.Atalaia</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">.. module:: Calculation</span>
<span class="sd">    :platform: Uniw, Windows</span>
<span class="sd">    :synopsis: module to calculate statistics for Atalaia form</span>

<span class="sd">.. moduleauthor:: Marie Jankujova &lt;jankujova.marie@fnusa.cz&gt;</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">date</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">time</span>
<span class="kn">from</span> <span class="nn">dateutil.relativedelta</span> <span class="k">import</span> <span class="n">relativedelta</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">xlsxwriter</span>
<span class="kn">from</span> <span class="nn">xlsxwriter.utility</span> <span class="k">import</span> <span class="n">xl_rowcol_to_cell</span><span class="p">,</span> <span class="n">xl_col_to_name</span>

<div class="viewcode-block" id="CheckTimes"><a class="viewcode-back" href="../../source/resqdb.html#resqdb.Atalaia.CheckTimes">[docs]</a><span class="k">class</span> <span class="nc">CheckTimes</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class calculating hospital days using discharge date and hospital date. </span>
<span class="sd">    </span>
<span class="sd">    This class provides some basic algorithms to fix hospital and discharge dates if calculated hospital days were &gt; 300 or &lt; 0.</span>

<span class="sd">    :param df: preprocessed data</span>
<span class="sd">    :type df: dataframe</span>
<span class="sd">    :param start_date: first date included in the dataframe</span>
<span class="sd">    :type start_date: date</span>
<span class="sd">    :param end_date: last date included in the dataframe</span>
<span class="sd">    :type end_date: date</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="n">debug</span> <span class="o">=</span> <span class="s1">&#39;debug_&#39;</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.log&#39;</span> 
        <span class="n">log_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">debug</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">log_file</span><span class="p">,</span>
                            <span class="n">filemode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span>
                            <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1">,</span><span class="si">%(msecs)d</span><span class="s1"> </span><span class="si">%(name)s</span><span class="s1"> </span><span class="si">%(levelname)s</span><span class="s1"> </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
                            <span class="n">datefmt</span><span class="o">=</span><span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">,</span>
                            <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Atalaia: Running calculation!&#39;</span><span class="p">)</span>   

        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span> <span class="o">=</span> <span class="n">start_date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span> <span class="o">=</span> <span class="n">end_date</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_null_dates</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;hospital_days&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_hospital_days</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;discharge_date_es&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;hospital_date_es&#39;</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">result_type</span><span class="o">=</span><span class="s1">&#39;expand&#39;</span><span class="p">)</span>

            <span class="c1"># Export negative hospital days into csv</span>
            <span class="n">negative_hospital_days</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;hospital_days&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">negative_hospital_days</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&quot;negative_hospital_days.csv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;hospital_days_fixed&#39;</span><span class="p">,</span> <span class="s1">&#39;hospital_date_fixed&#39;</span><span class="p">,</span> <span class="s1">&#39;discharge_date_fixed&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_negative_hospital_days</span><span class="p">(</span><span class="n">discharge_date</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;discharge_date_es&#39;</span><span class="p">],</span> <span class="n">hospital_date</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;hospital_date_es&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;hospital_days&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;hospital_days&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">300</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;hospital_days&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;hospital_date_es&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;discharge_date_es&#39;</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">result_type</span><span class="o">=</span><span class="s1">&#39;expand&#39;</span><span class="p">)</span>       

            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Atalaia: Negative and too much positive hospital days has been fixed!&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Atalaia: No available data!&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
 
<div class="viewcode-block" id="CheckTimes.filter_null_dates"><a class="viewcode-back" href="../../source/resqdb.html#resqdb.Atalaia.CheckTimes.filter_null_dates">[docs]</a>    <span class="k">def</span> <span class="nf">filter_null_dates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Filter out null discharge dates and null hospital dates. </span>

<span class="sd">        :returns: dataframe -- the filtered dataframe</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;discharge_date_es&#39;</span><span class="p">])]</span> 
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;hospital_date_es&#39;</span><span class="p">])]</span>  
        
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Atalaia: Patients with NULL discharge dates and NULL hospital dates has been filtered out!&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="CheckTimes.calculate_hospital_days"><a class="viewcode-back" href="../../source/resqdb.html#resqdb.Atalaia.CheckTimes.calculate_hospital_days">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_hospital_days</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">discharge_date</span><span class="p">,</span> <span class="n">hospital_date</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return difference in days between hospital date and discharge date. </span>

<span class="sd">        :param discharge_date: the discharge date</span>
<span class="sd">        :type discharge_date: date</span>
<span class="sd">        :param hospital_date: the hospital date</span>
<span class="sd">        :type hospital_date: date</span>
<span class="sd">        :returns: int -- the number of days</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hospital_days</span> <span class="o">=</span> <span class="p">(</span><span class="n">discharge_date</span> <span class="o">-</span> <span class="n">hospital_date</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>

        <span class="c1"># If hospital days is 0, then return 1 else return hospital days</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">hospital_days</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">hospital_days</span></div>

<div class="viewcode-block" id="CheckTimes.fix_negative_hospital_days"><a class="viewcode-back" href="../../source/resqdb.html#resqdb.Atalaia.CheckTimes.fix_negative_hospital_days">[docs]</a>    <span class="k">def</span> <span class="nf">fix_negative_hospital_days</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">discharge_date</span><span class="p">,</span> <span class="n">hospital_date</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Fix discharge date or hospital date if hospital days were &lt; 0 or &gt; 300. </span>

<span class="sd">        :param discharge_date: the discharge date</span>
<span class="sd">        :type discharge_date: date</span>
<span class="sd">        :param hospital_date: the hospital date</span>
<span class="sd">        :type hospital_date: date</span>
<span class="sd">        :returns: the fixed hospital days, the fixed hospital date, the fixed discharge date</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hospital_days</span> <span class="o">=</span> <span class="p">(</span><span class="n">discharge_date</span> <span class="o">-</span> <span class="n">hospital_date</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>
        <span class="n">discharge_date_new</span> <span class="o">=</span> <span class="n">discharge_date</span>
        <span class="n">hospital_date_new</span> <span class="o">=</span> <span class="n">hospital_date</span>

        <span class="k">if</span> <span class="n">hospital_days</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">300</span><span class="p">:</span>
            <span class="c1"># Add 1 year to discharge date</span>
            <span class="n">discharge_date_new</span> <span class="o">=</span> <span class="n">discharge_date</span> <span class="o">+</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">years</span><span class="o">=+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">hospital_days</span> <span class="o">&gt;</span> <span class="mi">300</span><span class="p">:</span>
            <span class="c1"># Add 1 year to hospital date</span>
            <span class="n">hospital_date_new</span> <span class="o">=</span> <span class="n">hospital_date</span> <span class="o">+</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">years</span><span class="o">=+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">hospital_days</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">31</span> <span class="ow">and</span> <span class="n">hospital_days</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Add 1 month to discharge date</span>
            <span class="n">discharge_date_new</span> <span class="o">=</span> <span class="n">discharge_date</span> <span class="o">+</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">months</span><span class="o">=+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">hospital_days</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">60</span> <span class="ow">and</span> <span class="n">hospital_days</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">31</span><span class="p">:</span>
            <span class="c1"># Add 2 months to discharge date</span>
            <span class="n">discharge_date_new</span> <span class="o">=</span> <span class="n">discharge_date</span> <span class="o">+</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">months</span><span class="o">=+</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">discharge_date_new</span> <span class="o">=</span> <span class="n">discharge_date</span>

        <span class="n">hospital_days_fixed</span> <span class="o">=</span> <span class="p">(</span><span class="n">discharge_date_new</span> <span class="o">-</span> <span class="n">hospital_date_new</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>
        <span class="k">if</span> <span class="n">hospital_days_fixed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">hospital_days_fixed</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">hospital_days_fixed</span><span class="p">,</span> <span class="n">hospital_date_new</span><span class="p">,</span> <span class="n">discharge_date_new</span></div></div>


<div class="viewcode-block" id="Filtration"><a class="viewcode-back" href="../../source/resqdb.html#resqdb.Atalaia.Filtration">[docs]</a><span class="k">class</span> <span class="nc">Filtration</span><span class="p">(</span><span class="n">CheckTimes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Class filtrating dataframe by discharge date. &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Filtration.filter_by_date"><a class="viewcode-back" href="../../source/resqdb.html#resqdb.Atalaia.Filtration.filter_by_date">[docs]</a>    <span class="k">def</span> <span class="nf">filter_by_date</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Filter dataframe by discharge date. The start date and end date were defined in :class:`resqdb.Atalaia.CheckTimes` class. </span>

<span class="sd">        :returns: the filtered dataframe</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;discharge_date_es&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;discharge_date_es&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span><span class="p">)]</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Atalaia: Raw data were filtered and include only rows with discharge date between </span><span class="si">{0}</span><span class="s1"> and </span><span class="si">{1}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_date</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">df</span></div></div>


<div class="viewcode-block" id="Calculation"><a class="viewcode-back" href="../../source/resqdb.html#resqdb.Atalaia.Calculation">[docs]</a><span class="k">class</span> <span class="nc">Calculation</span><span class="p">(</span><span class="n">Filtration</span><span class="p">):</span>
   
<div class="viewcode-block" id="Calculation.get_total_patients"><a class="viewcode-back" href="../../source/resqdb.html#resqdb.Atalaia.Calculation.get_total_patients">[docs]</a>    <span class="k">def</span> <span class="nf">get_total_patients</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The function calculating total number of patients per site.</span>
<span class="sd">        </span>
<span class="sd">        :returns: the temporary dataframe containing Site ID and total number of patients</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;site_id&#39;</span><span class="p">,</span> <span class="s1">&#39;facility_name&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;# total patients&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Atalaia: Total patients: OK.&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span> 
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Atalaia: Total patients: ERROR.&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Calculation.get_recan_below"><a class="viewcode-back" href="../../source/resqdb.html#resqdb.Atalaia.Calculation.get_recan_below">[docs]</a>    <span class="k">def</span> <span class="nf">get_recan_below</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtn</span><span class="p">,</span> <span class="n">dtg</span><span class="p">,</span> <span class="n">top</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The function checking if at least one from the pair of number is lesser then maximum. </span>
<span class="sd">        </span>
<span class="sd">        :param dtn: door to needle time value</span>
<span class="sd">        :type dtn: int</span>
<span class="sd">        :param dtg: door to groin time value</span>
<span class="sd">        :type dtg: int</span>
<span class="sd">        :param top: limit value</span>
<span class="sd">        :type top: int</span>
<span class="sd">        :returns: `True` if one from the pair is lesser then maximum, `False` otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">dtn</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">dtg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dtg</span> <span class="o">&gt;</span> <span class="n">top</span> <span class="ow">or</span> <span class="n">dtg</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">dtg</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">dtn</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">dtg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dtn</span> <span class="o">&gt;</span> <span class="n">top</span> <span class="ow">or</span> <span class="n">dtn</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">dtn</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">minimum</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">dtn</span><span class="p">,</span> <span class="n">dtg</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">minimum</span> <span class="o">&gt;</span> <span class="n">top</span> <span class="ow">or</span> <span class="n">minimum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="n">minimum</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">maximum</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">dtn</span><span class="p">,</span> <span class="n">dtg</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">maximum</span> <span class="o">&gt;</span> <span class="n">top</span> <span class="ow">or</span> <span class="n">maximum</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">maximum</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Calculation.get_recan_therapy"><a class="viewcode-back" href="../../source/resqdb.html#resqdb.Atalaia.Calculation.get_recan_therapy">[docs]</a>    <span class="k">def</span> <span class="nf">get_recan_therapy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The function calculating number of patients treated within 60/45 minutes by thrombolysis and within 90/60 by thrombectomy. The results are merged with the dataframe containing resulted statistic! &quot;&quot;&quot;</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">thrombolysis_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;recanalization_procedures_es&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">thrombectomy_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;recanalization_procedures_es&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">])]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">thrombolysis_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="c1"># If time of thrombolysis has been entered as timestamp for thrombolysis, calculate time in minutes from hospital_time_es and ivt_only_bolus_time_es</span>
                <span class="n">thrombolysis_df</span><span class="p">[</span><span class="s1">&#39;DTN_IVT_ONLY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thrombolysis_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_diff</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;hospital_time_es&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;ivt_only_bolus_time_es&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;recanalization_procedures_es&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;ivt_only_bolus_time_es&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;hospital_time_es&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1"># If time of thrombolysis has been entered as timestamp for thrombolysis and thrombectomy, calculate time in minutes from hospital_time_es and ivt_tby_bolus_time_es</span>
                <span class="n">thrombolysis_df</span><span class="p">[</span><span class="s1">&#39;DTN_IVT_TBY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thrombolysis_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_diff</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;hospital_time_es&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;ivt_tby_bolus_time_es&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;recanalization_procedures_es&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;ivt_tby_bolus_time_es&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;hospital_time_es&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1"># Merge two previously created columns into one</span>
                <span class="n">thrombolysis_df</span><span class="p">[</span><span class="s1">&#39;DTN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thrombolysis_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;DTN_IVT_ONLY&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;DTN_IVT_TBY&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">result_type</span><span class="o">=</span><span class="s1">&#39;expand&#39;</span><span class="p">)</span>
                <span class="c1"># Filter out rows with negative DTN</span>
                <span class="n">thrombolysis_df</span> <span class="o">=</span> <span class="n">thrombolysis_df</span><span class="p">[(</span><span class="n">thrombolysis_df</span><span class="p">[</span><span class="s1">&#39;DTN&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)]</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">thrombolysis_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="c1"># Thrombolysis &lt; 60 minutes</span>
                    <span class="n">thrombolysis_pts</span> <span class="o">=</span> <span class="n">thrombolysis_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;site_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;# patients eligible thrombolysis&quot;</span><span class="p">)</span>
                    <span class="n">thrombolysis_df</span><span class="p">[</span><span class="s1">&#39;recan_below_60&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">thrombolysis_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_recan_below</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;DTN&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">60</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> 
                    <span class="n">thrombolysis_within_60_df</span> <span class="o">=</span> <span class="n">thrombolysis_df</span><span class="p">[</span><span class="n">thrombolysis_df</span><span class="p">[</span><span class="s1">&#39;recan_below_60&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;site_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;# patients treated with door to thrombolysis &lt; 60 minutes&#39;</span><span class="p">)</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">thrombolysis_pts</span><span class="p">,</span> <span class="n">thrombolysis_within_60_df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;site_id&quot;</span><span class="p">)</span>
                    <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;% patients treated with door to thrombolysis &lt; 60 minutes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">round</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;# patients treated with door to thrombolysis &lt; 60 minutes&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;# patients eligible thrombolysis&#39;</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;# patients eligible thrombolysis&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                    <span class="c1"># Thrombolysis &lt; 45 minutes</span>
                    <span class="n">thrombolysis_df</span><span class="p">[</span><span class="s1">&#39;recan_below_45&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thrombolysis_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_recan_below</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;DTN&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">45</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">thrombolysis_within_45_df</span> <span class="o">=</span> <span class="n">thrombolysis_df</span><span class="p">[</span><span class="n">thrombolysis_df</span><span class="p">[</span><span class="s1">&#39;recan_below_45&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;site_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;# patients treated with door to thrombolysis &lt; 45 minutes&#39;</span><span class="p">)</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">thrombolysis_within_45_df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;site_id&quot;</span><span class="p">)</span>
                    <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;% patients treated with door to thrombolysis &lt; 45 minutes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">round</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;# patients treated with door to thrombolysis &lt; 45 minutes&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;# patients eligible thrombolysis&#39;</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;# patients eligible thrombolysis&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Atalaia: Number of patients treated by thrombolysis within 60/45 minutes has been calculated!&#39;</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;site_id&quot;</span><span class="p">)</span>  
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="p">[</span><span class="s1">&#39;# patients treated with door to thrombolysis &lt; 60 minutes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="p">[</span><span class="s1">&#39;% patients treated with door to thrombolysis &lt; 60 minutes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="p">[</span><span class="s1">&#39;# patients treated with door to thrombolysis &lt; 45 minutes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="p">[</span><span class="s1">&#39;% patients treated with door to thrombolysis &lt; 45 minutes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">thrombectomy_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="c1"># If time of thrombectomy has been entered as timestamp for thrombectomy, calculate time in minutes from hospital_time_es and ivt_tby_groin_puncture_time_es</span>
                <span class="n">thrombectomy_df</span><span class="p">[</span><span class="s1">&#39;DTG_IVT_TBY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thrombectomy_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_diff</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;hospital_time_es&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;ivt_tby_groin_puncture_time_es&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;recanalization_procedures_es&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;ivt_tby_groin_puncture_time_es&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;hospital_time_es&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1"># If time of thrombectomy has been entered as timestamp for thrombolysis and thrombectomy, calculate time in minutes from hospital_time_es and tby_only_puncture_time_es</span>
                <span class="n">thrombectomy_df</span><span class="p">[</span><span class="s1">&#39;DTG_TBY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thrombectomy_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_diff</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;hospital_time_es&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;tby_only_puncture_time_es&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;recanalization_procedures_es&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;tby_only_puncture_time_es&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;hospital_time_es&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1"># Merge two previously created columns into one</span>
                <span class="n">thrombectomy_df</span><span class="p">[</span><span class="s1">&#39;DTG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thrombectomy_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;DTG_IVT_TBY&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;DTG_TBY&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">result_type</span><span class="o">=</span><span class="s1">&#39;expand&#39;</span><span class="p">)</span>
                <span class="c1"># Filter out rows with negative DTG</span>
                <span class="n">thrombectomy_df</span> <span class="o">=</span> <span class="n">thrombectomy_df</span><span class="p">[(</span><span class="n">thrombectomy_df</span><span class="p">[</span><span class="s1">&#39;DTG&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)]</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">thrombectomy_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="c1"># Thrombectomy &lt; 90 minutes</span>
                    <span class="n">thrombectomy_pts</span> <span class="o">=</span> <span class="n">thrombectomy_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;site_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;# patients eligible thrombectomy&quot;</span><span class="p">)</span>
                    <span class="n">thrombectomy_df</span><span class="p">[</span><span class="s1">&#39;recan_below_90&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">thrombectomy_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_recan_below</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;DTG&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">90</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> 
                    <span class="n">thrombectomy_within_90_df</span> <span class="o">=</span> <span class="n">thrombectomy_df</span><span class="p">[</span><span class="n">thrombectomy_df</span><span class="p">[</span><span class="s1">&#39;recan_below_90&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;site_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;# patients treated with door to thrombectomy &lt; 90 minutes&#39;</span><span class="p">)</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">thrombectomy_pts</span><span class="p">,</span> <span class="n">thrombectomy_within_90_df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;site_id&quot;</span><span class="p">)</span>
                    <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;% patients treated with door to thrombectomy &lt; 90 minutes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">round</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;# patients treated with door to thrombectomy &lt; 90 minutes&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;# patients eligible thrombectomy&#39;</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;# patients eligible thrombectomy&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                    <span class="c1"># Thrombectomy &lt; 60 minutes</span>
                    <span class="n">thrombectomy_df</span><span class="p">[</span><span class="s1">&#39;recan_below_60&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thrombectomy_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_recan_below</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;DTG&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">60</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">thrombectomy_within_60_df</span> <span class="o">=</span> <span class="n">thrombectomy_df</span><span class="p">[</span><span class="n">thrombectomy_df</span><span class="p">[</span><span class="s1">&#39;recan_below_60&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;site_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;# patients treated with door to thrombectomy &lt; 60 minutes&#39;</span><span class="p">)</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">thrombectomy_within_60_df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;site_id&quot;</span><span class="p">)</span>
                    <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;% patients treated with door to thrombectomy &lt; 60 minutes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">round</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;# patients treated with door to thrombectomy &lt; 60 minutes&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;# patients eligible thrombectomy&#39;</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;# patients eligible thrombectomy&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Atalaia: Number of patients treated by thrombectomy within 90/60 minutes has been calculated!&#39;</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;site_id&quot;</span><span class="p">)</span> 
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="p">[</span><span class="s1">&#39;# patients treated with door to thrombectomy &lt; 90 minutes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="p">[</span><span class="s1">&#39;% patients treated with door to thrombectomy &lt; 90 minutes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="p">[</span><span class="s1">&#39;# patients treated with door to thrombectomy &lt; 60 minutes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="p">[</span><span class="s1">&#39;% patients treated with door to thrombectomy &lt; 60 minutes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Atalaia: Recanalization procedures: OK&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Atalaia: Recanalization procedures: ERROR&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Calculation.get_recan_rate"><a class="viewcode-back" href="../../source/resqdb.html#resqdb.Atalaia.Calculation.get_recan_rate">[docs]</a>    <span class="k">def</span> <span class="nf">get_recan_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The function calculating number of ischemic patients treated by recanalization procedure. The results are merged with the dataframe containing resulted statistic! &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ischemic_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;stroke_type_es&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">1</span><span class="p">])]</span> <span class="c1"># Ischemic stroke: stroke_type_es = 1</span>
            <span class="n">recan_rate_df</span> <span class="o">=</span> <span class="n">ischemic_df</span><span class="p">[</span><span class="n">ischemic_df</span><span class="p">[</span><span class="s1">&#39;recanalization_procedures_es&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">])]</span>
            <span class="n">ischemic_pts</span> <span class="o">=</span> <span class="n">ischemic_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;site_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;tmp_patients&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">recan_rate_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">recan_rate_pts</span> <span class="o">=</span> <span class="n">recan_rate_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;site_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;# recanalization rate out of total ischemic incidence&#39;</span><span class="p">)</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">recan_rate_pts</span><span class="p">,</span> <span class="n">ischemic_pts</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;site_id&quot;</span><span class="p">)</span>
                <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">% r</span><span class="s1">ecanalization rate out of total ischemic incidence&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">round</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;# recanalization rate out of total ischemic incidence&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;tmp_patients&#39;</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;tmp_patients&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;tmp_patients&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;site_id&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="p">[</span><span class="s1">&#39;# recanalization rate out of total ischemic incidence&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">% r</span><span class="s1">ecanalization rate out of total ischemic incidence&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Atalaia: Recanalization rate: OK&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Atalaia: Recanalization rate: ERROR&#39;</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="Calculation.get_ct_mri"><a class="viewcode-back" href="../../source/resqdb.html#resqdb.Atalaia.Calculation.get_ct_mri">[docs]</a>    <span class="k">def</span> <span class="nf">get_ct_mri</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The function calculating number of patients with IS, TIA and ICH stroke who have undergone the CT/MRI. The results are merged with the dataframe containing resulted statistic! &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Filter patients with ischemic stroke (stroke_type_es = 1), intracerebral hemorrhage (stroke_type_es = 2) and transient ischemic stroke (stroke_type_es = 3) patients who have undergone CT/MRI (ct_mri_es = 1)</span>
            <span class="n">ct_mri_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;stroke_type_es&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;ct_mri_es&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">1</span><span class="p">]))]</span> 
            <span class="n">is_tia_ich_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;stroke_type_es&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">])]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;site_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;tmp_patients&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ct_mri_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">ct_mri_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;site_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;# suspected stroke patients undergoing CT/MRI&#39;</span><span class="p">)</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">is_tia_ich_df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;site_id&quot;</span><span class="p">)</span>
                <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">% s</span><span class="s1">uspected stroke patients undergoing CT/MRI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">round</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;# suspected stroke patients undergoing CT/MRI&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;tmp_patients&#39;</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;tmp_patients&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;tmp_patients&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;site_id&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="p">[</span><span class="s1">&#39;# suspected stroke patients undergoing CT/MRI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">% s</span><span class="s1">uspected stroke patients undergoing CT/MRI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Atalaia: CT/MRI: OK&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Atalaia: CT/MRI: ERROR&#39;</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="Calculation.get_dysphagia_screening"><a class="viewcode-back" href="../../source/resqdb.html#resqdb.Atalaia.Calculation.get_dysphagia_screening">[docs]</a>    <span class="k">def</span> <span class="nf">get_dysphagia_screening</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The function calculating number of patients with IS and ICH stroke who have undergone the dysphagia screening. The results are merged with the dataframe containing resulted statistic! &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Filter patients with ischemic stroke (stroke_type_es = 1) and intracerebral hemorrhage (stroke_type_es = 2) patients who have undergone GUSS test (dysphagia_screening_es = 1) or other test (dysphagia_screening_es = 2)</span>
            <span class="n">dysphagia_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;stroke_type_es&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;dysphagia_screening_es&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]))]</span>
            <span class="c1"># Filter patients with ischemic stroke (stroke_type_es = 1) and intracerebral hemorrhage (stroke_type_es = 2) patients who have undergone GUSS test (dysphagia_screening_es = 1), other test (dysphagia_screening_es = 2) or has not been tested (dysphagia_screening_es = 4)</span>
            <span class="n">dysphagia_ntest_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;stroke_type_es&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;dysphagia_screening_es&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">]))]</span>
            <span class="n">dysphagia_ntest_tmp_df</span> <span class="o">=</span> <span class="n">dysphagia_ntest_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;site_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;tmp_patients&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">dysphagia_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">dysphagia_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;site_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;# all stroke patients undergoing dysphagia screening&#39;</span><span class="p">)</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">dysphagia_ntest_tmp_df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;site_id&quot;</span><span class="p">)</span>
                <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;% all stroke patients undergoing dysphagia screening&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">round</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;# all stroke patients undergoing dysphagia screening&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;tmp_patients&#39;</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;tmp_patients&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;tmp_patients&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;site_id&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="p">[</span><span class="s1">&#39;# all stroke patients undergoing dysphagia screening&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="p">[</span><span class="s1">&#39;% all stroke patients undergoing dysphagia screening&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Atalaia: Dysphagia screening: OK&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Atalaia: Dysphagia screening: ERROR&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Calculation.get_patients_discharged_with_antiplatelets"><a class="viewcode-back" href="../../source/resqdb.html#resqdb.Atalaia.Calculation.get_patients_discharged_with_antiplatelets">[docs]</a>    <span class="k">def</span> <span class="nf">get_patients_discharged_with_antiplatelets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The function calculating number of ischemic patients who have been discharged with prescribed antiplatelets. The results are merged with the dataframe containing resulted statistic! &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Filter patients with ischemic stroke (stroke_type_es = 1)</span>
            <span class="n">ischemic_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;stroke_type_es&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">1</span><span class="p">])]</span>

            <span class="c1"># Filter ischemic patients who has not been detected for aFib (afib_flutter_es = 3), no detection done (afib_flutter_es = 4) and unknown for aFib (afib_flutter_es = 5) who has not died in the hospital (discharge_destination_es != 5) and had prescribed antiplatelets (antithrombotics_es = 1)</span>
            <span class="n">antiplatelets_df</span> <span class="o">=</span> <span class="n">ischemic_df</span><span class="p">[(</span><span class="n">ischemic_df</span><span class="p">[</span><span class="s1">&#39;afib_flutter_es&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ischemic_df</span><span class="p">[</span><span class="s1">&#39;discharge_destination_es&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">5</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">ischemic_df</span><span class="p">[</span><span class="s1">&#39;antithrombotics_es&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">1</span><span class="p">]))]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># Filter ischemic patients who has not been detected for aFib (afib_flutter_es = 3), no detection done (afib_flutter_es = 4) and unknown for aFib (afib_flutter_es = 5) who has not died in the hospital (discharge_destination_es != 5) and had not recommended antithrombotics (antithrombotics_es != 9)</span>
            <span class="n">antiplatelets_recs_df</span> <span class="o">=</span> <span class="n">ischemic_df</span><span class="p">[(</span><span class="n">ischemic_df</span><span class="p">[</span><span class="s1">&#39;afib_flutter_es&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ischemic_df</span><span class="p">[</span><span class="s1">&#39;discharge_destination_es&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">5</span><span class="p">])</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ischemic_df</span><span class="p">[</span><span class="s1">&#39;antithrombotics_es&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">9</span><span class="p">]))]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">antiplatelets_recs_tmp_df</span> <span class="o">=</span> <span class="n">antiplatelets_recs_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;site_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;tmp_patients&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">antiplatelets_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">antiplatelets_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;site_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;# ischemic stroke patients discharged with antiplatelets&#39;</span><span class="p">)</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">antiplatelets_recs_tmp_df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;site_id&quot;</span><span class="p">)</span>
                <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">% i</span><span class="s1">schemic stroke patients discharged with antiplatelets&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">round</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;# ischemic stroke patients discharged with antiplatelets&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;tmp_patients&#39;</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;tmp_patients&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;tmp_patients&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;site_id&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="p">[</span><span class="s1">&#39;# ischemic stroke patients discharged with antiplatelets&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">% i</span><span class="s1">schemic stroke patients discharged with antiplatelets&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Atalaia: Discharged with antiplatelets: OK&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Atalaia: Discharged with antiplatelets: ERROR&#39;</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Filter patients with ischemic stroke (stroke_type_es = 1)</span>
            <span class="n">ischemic_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;stroke_type_es&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">1</span><span class="p">])]</span>
            <span class="c1"># Filter ischemic patients who has not been detected for aFib (afib_flutter_es = 3), no detection done (afib_flutter_es = 4) and unknown for aFib (afib_flutter_es = 5) who has been discharged at home (discharge_destination_es = 1) and had prescribed antiplatelets (antithrombotics_es = 1)</span>
            <span class="n">antiplatelets_df</span> <span class="o">=</span> <span class="n">ischemic_df</span><span class="p">[(</span><span class="n">ischemic_df</span><span class="p">[</span><span class="s1">&#39;afib_flutter_es&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">ischemic_df</span><span class="p">[</span><span class="s1">&#39;discharge_destination_es&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">ischemic_df</span><span class="p">[</span><span class="s1">&#39;antithrombotics_es&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">1</span><span class="p">]))]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c1"># Filter ischemic patients who has not been detected for aFib (afib_flutter_es = 3), no detection done (afib_flutter_es = 4) and unknown for aFib (afib_flutter_es = 5) who has been discharged at home (discharge_destination_es = 1) and had not recommended antithrombotics (antithrombotics_es != 9)</span>
            <span class="n">antiplatelets_recs_df</span> <span class="o">=</span> <span class="n">ischemic_df</span><span class="p">[(</span><span class="n">ischemic_df</span><span class="p">[</span><span class="s1">&#39;afib_flutter_es&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">ischemic_df</span><span class="p">[</span><span class="s1">&#39;discharge_destination_es&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ischemic_df</span><span class="p">[</span><span class="s1">&#39;antithrombotics_es&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">9</span><span class="p">]))]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">antiplatelets_recs_tmp_df</span> <span class="o">=</span> <span class="n">antiplatelets_recs_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;site_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;tmp_patients&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">antiplatelets_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">antiplatelets_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;site_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;# ischemic stroke patients discharged home with antiplatelets&#39;</span><span class="p">)</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">antiplatelets_recs_tmp_df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;site_id&quot;</span><span class="p">)</span>
                <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">% i</span><span class="s1">schemic stroke patients discharged home with antiplatelets&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">round</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;# ischemic stroke patients discharged home with antiplatelets&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;tmp_patients&#39;</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;tmp_patients&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;tmp_patients&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;site_id&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="p">[</span><span class="s1">&#39;# ischemic stroke patients discharged home with antiplatelets&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">% i</span><span class="s1">schemic stroke patients discharged home with antiplatelets&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Discharged home with antiplatelets: OK&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Discharged home with antiplatelets: ERROR&#39;</span><span class="p">)</span>

        <span class="c1"># Compare number of patients discharged with antiplatelets with discharge home with antiplatelets and get the highest number. </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="p">[</span><span class="s1">&#39;# ischemic stroke patients discharged (home) with antiplatelets&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;# ischemic stroke patients discharged with antiplatelets&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">% i</span><span class="s1">schemic stroke patients discharged with antiplatelets&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">% i</span><span class="s1">schemic stroke patients discharged home with antiplatelets&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;# ischemic stroke patients discharged home with antiplatelets&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">% i</span><span class="s1">schemic stroke patients discharged (home) with antiplatelets&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">% i</span><span class="s1">schemic stroke patients discharged with antiplatelets&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">% i</span><span class="s1">schemic stroke patients discharged with antiplatelets&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">% i</span><span class="s1">schemic stroke patients discharged home with antiplatelets&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">% i</span><span class="s1">schemic stroke patients discharged home with antiplatelets&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

        <span class="c1"># self.stats_df.drop([&#39;# ischemic stroke patients discharged with antiplatelets&#39;, &#39;% ischemic stroke patients discharged with antiplatelets&#39;, &#39;# ischemic stroke patients discharged home with antiplatelets&#39;, &#39;% ischemic stroke patients discharged home with antiplatelets&#39;], axis=1, inplace=True)</span>

<div class="viewcode-block" id="Calculation.get_afib_discharged_with_anticoagulants"><a class="viewcode-back" href="../../source/resqdb.html#resqdb.Atalaia.Calculation.get_afib_discharged_with_anticoagulants">[docs]</a>    <span class="k">def</span> <span class="nf">get_afib_discharged_with_anticoagulants</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The function calculating number of patients who have been discharged with prescribed anticoagulants with aFib. The results are merged with the dataframe containing resulted statistic! &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Filter patients known for aFib (afib_flutter_es = 1) or detected for aFib (afib_flutter_es = 2) who has not died in the hospital (discharge_destination_es != 5) and had prescribed antithrombotics (antithrombotics_es = 2,3,4,5,6,7,8)</span>
            <span class="n">anticoagulants_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;afib_flutter_es&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;</span> <span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;discharge_destination_es&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">5</span><span class="p">])</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;antithrombotics_es&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">]))]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c1"># Filter patients known for aFib (afib_flutter_es = 1) or detected for aFib (afib_flutter_es = 2) who has not died in the hospital (discharge_destination_es != 5) and had prescribed antithrombotics or not prescribed at all (antithrombotics_es = 2,3,4,5,6,7,8,10)</span>
            <span class="n">anticoagulants_recs_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;afib_flutter_es&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;</span> <span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;discharge_destination_es&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">5</span><span class="p">])</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;antithrombotics_es&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">10</span><span class="p">]))]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">anticoagulants_recs_tmp_df</span> <span class="o">=</span> <span class="n">anticoagulants_recs_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;site_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;tmp_patients&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">anticoagulants_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>    
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">anticoagulants_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;site_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;# afib patients discharged with anticoagulants&#39;</span><span class="p">)</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">anticoagulants_recs_tmp_df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;site_id&quot;</span><span class="p">)</span>
                <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;% afib patients discharged with anticoagulants&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">round</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;# afib patients discharged with anticoagulants&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;tmp_patients&#39;</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;tmp_patients&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;tmp_patients&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;site_id&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="p">[</span><span class="s1">&#39;# afib patients discharged with anticoagulants&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="p">[</span><span class="s1">&#39;% afib patients discharged with anticoagulants&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Atalaia: Discharged with anticoagulants: OK&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Atalaia: Discharged with anticoagulants: ERROR&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Filter patients known for aFib (afib_flutter_es = 1) or detected for aFib (afib_flutter_es = 2) who has been discharge home (discharge_destination_es = 1) and had prescribed antithrombotics (antithrombotics_es = 2,3,4,5,6,7,8)</span>
            <span class="n">anticoagulants_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;afib_flutter_es&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;discharge_destination_es&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;antithrombotics_es&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">]))]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c1"># Filter patients known for aFib (afib_flutter_es = 1) or detected for aFib (afib_flutter_es = 2) who has been discharge home (discharge_destination_es = 1) and had prescribed antithrombotics or not prescribed at all (antithrombotics_es = 2,3,4,5,6,7,8,10)</span>
            <span class="n">anticoagulants_recs_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;afib_flutter_es&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;discharge_destination_es&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;antithrombotics_es&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">10</span><span class="p">]))]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">anticoagulants_recs_tmp_df</span> <span class="o">=</span> <span class="n">anticoagulants_recs_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;site_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;tmp_patients&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">anticoagulants_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>    
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">anticoagulants_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;site_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;# afib patients discharged home with anticoagulants&#39;</span><span class="p">)</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">anticoagulants_recs_tmp_df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;site_id&quot;</span><span class="p">)</span>
                <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;% afib patients discharged home with anticoagulants&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">round</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;# afib patients discharged home with anticoagulants&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;tmp_patients&#39;</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;tmp_patients&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;tmp_patients&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;site_id&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="p">[</span><span class="s1">&#39;# afib patients discharged home with anticoagulants&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="p">[</span><span class="s1">&#39;% afib patients discharged home with anticoagulants&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Atalaia: Discharged with home anticoagulants: OK&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Atalaia: Discharged with home anticoagulants: ERROR&#39;</span><span class="p">)</span>

        <span class="c1"># Compare number of patients discharged with anticoagulants with discharge home with anticoagulants and get the highest number.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="p">[</span><span class="s1">&#39;# afib patients discharged (home) with anticoagulants&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;# afib patients discharged with anticoagulants&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;% afib patients discharged with anticoagulants&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;% afib patients discharged home with anticoagulants&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;# afib patients discharged home with anticoagulants&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="p">[</span><span class="s1">&#39;% afib patients discharged (home) with anticoagulants&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;% afib patients discharged with anticoagulants&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;% afib patients discharged with anticoagulants&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;% afib patients discharged home with anticoagulants&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;% afib patients discharged home with anticoagulants&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

        <span class="c1"># self.stats_df.drop([&#39;# afib patients discharged with anticoagulants&#39;, &#39;% afib patients discharged with anticoagulants&#39;, &#39;# afib patients discharged home with anticoagulants&#39;, &#39;% afib patients discharged home with anticoagulants&#39;], axis=1, inplace=True)</span>

<div class="viewcode-block" id="Calculation.get_hospitalized_in"><a class="viewcode-back" href="../../source/resqdb.html#resqdb.Atalaia.Calculation.get_hospitalized_in">[docs]</a>    <span class="k">def</span> <span class="nf">get_hospitalized_in</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The function calculating number of patients who have been hospitalized in a dedicated stroke unit / ICU. The results are merged with the dataframe containing resulted statistic! &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Filter patients hospitalized in a dedicated stroke unit (hospitalized_in_es = 1)</span>
            <span class="n">hosp_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;hospitalized_in_es&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">hosp_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">hosp_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;site_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;# stroke patients treated in a dedicated stroke unit / ICU&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;site_id&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">% s</span><span class="s1">troke patients treated in a dedicated stroke unit / ICU&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">round</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;# stroke patients treated in a dedicated stroke unit / ICU&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;# total patients&#39;</span><span class="p">])</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;# total patients&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="p">[</span><span class="s1">&#39;# stroke patients treated in a dedicated stroke unit / ICU&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">% s</span><span class="s1">troke patients treated in a dedicated stroke unit / ICU&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Atalaia: Hospitalized in stroke unit: OK&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Atalaia: Hospitalized in stroke unit: ERROR&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_final_award</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The function calculating the final award. The results are merged with the dataframe containing resulted statistic! </span>
<span class="sd">        </span>
<span class="sd">        :param x: the row with the values to calculate proposed award</span>
<span class="sd">        :type x: pandas series</span>
<span class="sd">        :returns: proposed award</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Total Patients&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">award</span> <span class="o">=</span> <span class="s2">&quot;NONE&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">award</span> <span class="o">=</span> <span class="s2">&quot;TRUE&quot;</span>

        <span class="n">thrombolysis_pts</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;# patients eligible thrombolysis&#39;</span><span class="p">]</span>
        
        <span class="c1"># Calculate award for thrombolysis, if no patients were eligible for thrombolysis and number of total patients was greater than minimum than the award is set to DIAMOND </span>
        <span class="n">thrombolysis_therapy_lt_60min</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;% patients treated with door to thrombolysis &lt; 60 minutes&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">award</span> <span class="o">==</span> <span class="s2">&quot;TRUE&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">thrombolysis_pts</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">award</span> <span class="o">=</span> <span class="s2">&quot;DIAMOND&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">thrombolysis_therapy_lt_60min</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">50</span> <span class="ow">and</span> <span class="nb">float</span><span class="p">(</span><span class="n">thrombolysis_therapy_lt_60min</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">74.99</span><span class="p">):</span>
                    <span class="n">award</span> <span class="o">=</span> <span class="s2">&quot;GOLD&quot;</span>
                <span class="k">elif</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">thrombolysis_therapy_lt_60min</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">75</span><span class="p">):</span>
                    <span class="n">award</span> <span class="o">=</span> <span class="s2">&quot;DIAMOND&quot;</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="n">award</span> <span class="o">=</span> <span class="s2">&quot;NONE&quot;</span>

        <span class="n">thrombolysis_therapy_lt_45min</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;% patients treated with door to thrombolysis &lt; 45 minutes&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">award</span> <span class="o">!=</span> <span class="s2">&quot;NONE&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">thrombolysis_pts</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">award</span> <span class="o">=</span> <span class="s2">&quot;DIAMOND&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">thrombolysis_therapy_lt_45min</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">49.99</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">award</span> <span class="o">!=</span> <span class="s2">&quot;GOLD&quot;</span> <span class="ow">or</span> <span class="n">award</span> <span class="o">==</span> <span class="s2">&quot;DIAMOND&quot;</span><span class="p">):</span>
                        <span class="n">award</span> <span class="o">=</span> <span class="s2">&quot;PLATINUM&quot;</span>
                <span class="k">elif</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">thrombolysis_therapy_lt_45min</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">50</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">award</span> <span class="o">!=</span> <span class="s2">&quot;GOLD&quot;</span><span class="p">):</span>
                        <span class="n">award</span> <span class="o">=</span> <span class="s2">&quot;DIAMOND&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">award</span> <span class="o">=</span> <span class="s2">&quot;NONE&quot;</span>

        <span class="c1"># Calculate award for thrombectomy, if no patients were eligible for thrombectomy and number of total patients was greater than minimum than the award is set to the possible proposed award (eg. if in thrombolysis step award was set to GOLD then the award will be GOLD)</span>
        <span class="n">thrombectomy_pts</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;# patients eligible thrombectomy&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">thrombectomy_pts</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">thrombectomy_therapy_lt_90min</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;% patients treated with door to thrombectomy &lt; 90 minutes&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">award</span> <span class="o">!=</span> <span class="s2">&quot;NONE&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">thrombectomy_therapy_lt_90min</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">50</span> <span class="ow">and</span> <span class="nb">float</span><span class="p">(</span><span class="n">thrombectomy_therapy_lt_90min</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">74.99</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">award</span> <span class="o">==</span> <span class="s2">&quot;PLATINUM&quot;</span> <span class="ow">or</span> <span class="n">award</span> <span class="o">==</span> <span class="s2">&quot;DIAMOND&quot;</span><span class="p">):</span>
                        <span class="n">award</span> <span class="o">=</span> <span class="s2">&quot;GOLD&quot;</span>
                <span class="k">elif</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">thrombectomy_therapy_lt_90min</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">75</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">award</span> <span class="o">==</span> <span class="s2">&quot;DIAMOND&quot;</span><span class="p">):</span>
                        <span class="n">award</span> <span class="o">=</span> <span class="s2">&quot;DIAMOND&quot;</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="n">award</span> <span class="o">=</span> <span class="s2">&quot;NONE&quot;</span>

            <span class="n">thrombectomy_therapy_lt_60min</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;% patients treated with door to thrombectomy &lt; 60 minutes&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">award</span> <span class="o">!=</span> <span class="s2">&quot;NONE&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">thrombectomy_therapy_lt_60min</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">49.99</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">award</span> <span class="o">!=</span> <span class="s2">&quot;GOLD&quot;</span> <span class="ow">or</span> <span class="n">award</span> <span class="o">==</span> <span class="s2">&quot;DIAMOND&quot;</span><span class="p">):</span>
                        <span class="n">award</span> <span class="o">=</span> <span class="s2">&quot;PLATINUM&quot;</span>
                <span class="k">elif</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">thrombectomy_therapy_lt_60min</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">50</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">award</span> <span class="o">==</span> <span class="s2">&quot;DIAMOND&quot;</span><span class="p">):</span>
                        <span class="n">award</span> <span class="o">=</span> <span class="s2">&quot;DIAMOND&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">award</span> <span class="o">=</span> <span class="s2">&quot;NONE&quot;</span>

        <span class="n">recan_rate</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">% r</span><span class="s1">ecanalization rate out of total ischemic incidence&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">award</span> <span class="o">!=</span> <span class="s2">&quot;NONE&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">recan_rate</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">5</span> <span class="ow">and</span> <span class="nb">float</span><span class="p">(</span><span class="n">recan_rate</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">14.99</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">award</span> <span class="o">==</span> <span class="s2">&quot;PLATINUM&quot;</span> <span class="ow">or</span> <span class="n">award</span> <span class="o">==</span> <span class="s2">&quot;DIAMOND&quot;</span><span class="p">):</span>
                    <span class="n">award</span> <span class="o">=</span> <span class="s2">&quot;GOLD&quot;</span>
            <span class="k">elif</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">recan_rate</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">15</span> <span class="ow">and</span> <span class="nb">float</span><span class="p">(</span><span class="n">recan_rate</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">24.99</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">award</span> <span class="o">==</span> <span class="s2">&quot;DIAMOND&quot;</span><span class="p">):</span>
                    <span class="n">award</span> <span class="o">=</span> <span class="s2">&quot;PLATINUM&quot;</span>
            <span class="k">elif</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">recan_rate</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">25</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">award</span> <span class="o">==</span> <span class="s2">&quot;DIAMOND&quot;</span><span class="p">):</span>
                    <span class="n">award</span> <span class="o">=</span> <span class="s2">&quot;DIAMOND&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">award</span> <span class="o">=</span> <span class="s2">&quot;NONE&quot;</span>

        <span class="n">ct_mri</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">% s</span><span class="s1">uspected stroke patients undergoing CT/MRI&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">award</span> <span class="o">!=</span> <span class="s2">&quot;NONE&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ct_mri</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">80</span> <span class="ow">and</span> <span class="nb">float</span><span class="p">(</span><span class="n">ct_mri</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">84.99</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">award</span> <span class="o">==</span> <span class="s2">&quot;PLATINUM&quot;</span> <span class="ow">or</span> <span class="n">award</span> <span class="o">==</span> <span class="s2">&quot;DIAMOND&quot;</span><span class="p">):</span>
                    <span class="n">award</span> <span class="o">=</span> <span class="s2">&quot;GOLD&quot;</span>
            <span class="k">elif</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ct_mri</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">85</span> <span class="ow">and</span> <span class="nb">float</span><span class="p">(</span><span class="n">ct_mri</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">89.99</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">award</span> <span class="o">==</span> <span class="s2">&quot;DIAMOND&quot;</span><span class="p">):</span>
                    <span class="n">award</span> <span class="o">=</span> <span class="s2">&quot;PLATINUM&quot;</span>
            <span class="k">elif</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ct_mri</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">90</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">award</span> <span class="o">==</span> <span class="s2">&quot;DIAMOND&quot;</span><span class="p">):</span>
                    <span class="n">award</span> <span class="o">=</span> <span class="s2">&quot;DIAMOND&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">award</span> <span class="o">=</span> <span class="s2">&quot;NONE&quot;</span>

        <span class="n">dysphagia_screening</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;% all stroke patients undergoing dysphagia screening&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">award</span> <span class="o">!=</span> <span class="s2">&quot;NONE&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">dysphagia_screening</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">80</span> <span class="ow">and</span> <span class="nb">float</span><span class="p">(</span><span class="n">dysphagia_screening</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">84.99</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">award</span> <span class="o">==</span> <span class="s2">&quot;PLATINUM&quot;</span> <span class="ow">or</span> <span class="n">award</span> <span class="o">==</span> <span class="s2">&quot;DIAMOND&quot;</span><span class="p">):</span>
                    <span class="n">award</span> <span class="o">=</span> <span class="s2">&quot;GOLD&quot;</span>
            <span class="k">elif</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">dysphagia_screening</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">85</span> <span class="ow">and</span> <span class="nb">float</span><span class="p">(</span><span class="n">dysphagia_screening</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">89.99</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">award</span> <span class="o">==</span> <span class="s2">&quot;DIAMOND&quot;</span><span class="p">):</span>
                    <span class="n">award</span> <span class="o">=</span> <span class="s2">&quot;PLATINUM&quot;</span>
            <span class="k">elif</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">dysphagia_screening</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">90</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">award</span> <span class="o">==</span> <span class="s2">&quot;DIAMOND&quot;</span><span class="p">):</span>
                    <span class="n">award</span> <span class="o">=</span> <span class="s2">&quot;DIAMOND&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">award</span> <span class="o">=</span> <span class="s2">&quot;NONE&quot;</span>

        <span class="n">discharged_with_antiplatelets_final</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">% i</span><span class="s1">schemic stroke patients discharged (home) with antiplatelets&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">award</span> <span class="o">!=</span> <span class="s2">&quot;NONE&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">discharged_with_antiplatelets_final</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">80</span> <span class="ow">and</span> <span class="nb">float</span><span class="p">(</span><span class="n">discharged_with_antiplatelets_final</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">84.99</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">award</span> <span class="o">==</span> <span class="s2">&quot;PLATINUM&quot;</span> <span class="ow">or</span> <span class="n">award</span> <span class="o">==</span> <span class="s2">&quot;DIAMOND&quot;</span><span class="p">):</span>
                    <span class="n">award</span> <span class="o">=</span> <span class="s2">&quot;GOLD&quot;</span>
            <span class="k">elif</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">discharged_with_antiplatelets_final</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">85</span> <span class="ow">and</span> <span class="nb">float</span><span class="p">(</span><span class="n">discharged_with_antiplatelets_final</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">89.99</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">award</span> <span class="o">==</span> <span class="s2">&quot;DIAMOND&quot;</span><span class="p">):</span>
                    <span class="n">award</span> <span class="o">=</span> <span class="s2">&quot;PLATINUM&quot;</span>
            <span class="k">elif</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">discharged_with_antiplatelets_final</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">90</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">award</span> <span class="o">==</span> <span class="s2">&quot;DIAMOND&quot;</span><span class="p">):</span>
                    <span class="n">award</span> <span class="o">=</span> <span class="s2">&quot;DIAMOND&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">award</span> <span class="o">=</span> <span class="s2">&quot;NONE&quot;</span>

        <span class="n">discharged_with_anticoagulants_final</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;% afib patients discharged (home) with anticoagulants&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">award</span> <span class="o">!=</span> <span class="s2">&quot;NONE&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">discharged_with_anticoagulants_final</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">80</span> <span class="ow">and</span> <span class="nb">float</span><span class="p">(</span><span class="n">discharged_with_anticoagulants_final</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">84.99</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">award</span> <span class="o">==</span> <span class="s2">&quot;PLATINUM&quot;</span> <span class="ow">or</span> <span class="n">award</span> <span class="o">==</span> <span class="s2">&quot;DIAMOND&quot;</span><span class="p">):</span>
                    <span class="n">award</span> <span class="o">=</span> <span class="s2">&quot;GOLD&quot;</span>
            <span class="k">elif</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">discharged_with_anticoagulants_final</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">85</span> <span class="ow">and</span> <span class="nb">float</span><span class="p">(</span><span class="n">discharged_with_anticoagulants_final</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">89.99</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">award</span> <span class="o">==</span> <span class="s2">&quot;DIAMOND&quot;</span><span class="p">):</span>
                    <span class="n">award</span> <span class="o">=</span> <span class="s2">&quot;PLATINUM&quot;</span>
            <span class="k">elif</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">discharged_with_anticoagulants_final</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">90</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">award</span> <span class="o">==</span> <span class="s2">&quot;DIAMOND&quot;</span><span class="p">):</span>
                    <span class="n">award</span> <span class="o">=</span> <span class="s2">&quot;DIAMOND&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">award</span> <span class="o">=</span> <span class="s2">&quot;NONE&quot;</span>

        <span class="n">stroke_unit</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">% s</span><span class="s1">troke patients treated in a dedicated stroke unit / ICU&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">award</span> <span class="o">!=</span> <span class="s2">&quot;NONE&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">stroke_unit</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">0.99</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">award</span> <span class="o">==</span> <span class="s2">&quot;DIAMOND&quot;</span><span class="p">):</span>
                    <span class="n">award</span> <span class="o">=</span> <span class="s2">&quot;PLATINUM&quot;</span>
            <span class="k">elif</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">stroke_unit</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">award</span> <span class="o">==</span> <span class="s2">&quot;DIAMOND&quot;</span><span class="p">):</span>
                    <span class="n">award</span> <span class="o">=</span> <span class="s2">&quot;DIAMOND&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">award</span> <span class="o">=</span> <span class="s2">&quot;NONE&quot;</span>

        <span class="k">return</span> <span class="n">award</span>


<div class="viewcode-block" id="Calculation.get_stats_df"><a class="viewcode-back" href="../../source/resqdb.html#resqdb.Atalaia.Calculation.get_stats_df">[docs]</a>    <span class="k">def</span> <span class="nf">get_stats_df</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The function calculating the statistics. </span>
<span class="sd">        </span>
<span class="sd">        :returns: stats_df -- dataframe with calculated statistics</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_by_date</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preprocessed_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_total_patients</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="p">[</span><span class="s1">&#39;Total Patients&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;TRUE&#39;</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;# total patients&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">30</span> <span class="k">else</span> <span class="s1">&#39;FALSE&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_recan_therapy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_recan_rate</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_ct_mri</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_dysphagia_screening</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_patients_discharged_with_antiplatelets</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_afib_discharged_with_anticoagulants</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_hospitalized_in</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="p">[</span><span class="s1">&#39;Proposed Award&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_final_award</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># Delete redundant columns</span>
            <span class="n">columns_to_delete</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;# patients eligible thrombectomy&#39;</span><span class="p">,</span> <span class="s1">&#39;# patients eligible thrombolysis&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">columns_to_delete</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">i</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rename_column</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Atalaia: Angels Awards statistic was calculated successfully.&#39;</span><span class="p">)</span>     
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Atalaia: There are no data for the selected date range.&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Calculation.time_diff"><a class="viewcode-back" href="../../source/resqdb.html#resqdb.Atalaia.Calculation.time_diff">[docs]</a>    <span class="k">def</span> <span class="nf">time_diff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The function calculating difference between two times. </span>
<span class="sd">        </span>
<span class="sd">        :param start: the first time</span>
<span class="sd">        :type start: time</span>
<span class="sd">        :param end: the end time</span>
<span class="sd">        :type end: time</span>
<span class="sd">        :returns: int -- difference in minutes</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span> <span class="c1"># convert to datetime</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">min</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">[</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">:</span> <span class="c1"># e.g., 10:33:26-11:15:49</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">/</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># end &lt; start e.g., 23:55:00-00:25:00</span>
            <span class="c1"># assert end &gt; start</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">/</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">500</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">end</span> <span class="o">&gt;</span> <span class="n">start</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">/</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">/</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="Calculation.rename_column"><a class="viewcode-back" href="../../source/resqdb.html#resqdb.Atalaia.Calculation.rename_column">[docs]</a>    <span class="k">def</span> <span class="nf">rename_column</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The function renaming site_id and facility_name column names to Site ID and Site Name! &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stats_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;site_id&#39;</span><span class="p">:</span> <span class="s1">&#39;Site ID&#39;</span><span class="p">,</span> <span class="s1">&#39;facility_name&#39;</span><span class="p">:</span> <span class="s1">&#39;Site Name&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div></div>
    
        
<div class="viewcode-block" id="FormatStatistic"><a class="viewcode-back" href="../../source/resqdb.html#resqdb.Atalaia.FormatStatistic">[docs]</a><span class="k">class</span> <span class="nc">FormatStatistic</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; Class generating formatted excel file containing the calculated statistics! </span>
<span class="sd">    </span>
<span class="sd">    :param df: the dataframe with calculated statistics</span>
<span class="sd">    :type df: dataframe</span>
<span class="sd">    :param path: the path where the output file should be saved</span>
<span class="sd">    :type path: str</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>

        <span class="n">debug</span> <span class="o">=</span> <span class="s1">&#39;debug_&#39;</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.log&#39;</span> 
        <span class="n">log_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">debug</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">log_file</span><span class="p">,</span>
                            <span class="n">filemode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span>
                            <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1">,</span><span class="si">%(msecs)d</span><span class="s1"> </span><span class="si">%(name)s</span><span class="s1"> </span><span class="si">%(levelname)s</span><span class="s1"> </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
                            <span class="n">datefmt</span><span class="o">=</span><span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">,</span>
                            <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Running FormatStatistic&#39;</span><span class="p">)</span> 

        <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>

<div class="viewcode-block" id="FormatStatistic.format"><a class="viewcode-back" href="../../source/resqdb.html#resqdb.Atalaia.FormatStatistic.format">[docs]</a>    <span class="k">def</span> <span class="nf">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>    
        <span class="sd">&quot;&quot;&quot; The function creating excel file and add formatting! </span>
<span class="sd">        </span>
<span class="sd">        :param df: the dataframe with the statistics</span>
<span class="sd">        :type df: dataframe</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">workbook1</span> <span class="o">=</span> <span class="n">xlsxwriter</span><span class="o">.</span><span class="n">Workbook</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;strings_to_numbers&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
        <span class="n">worksheet</span> <span class="o">=</span> <span class="n">workbook1</span><span class="o">.</span><span class="n">add_worksheet</span><span class="p">()</span>

        <span class="c1"># set width of columns</span>
        <span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
        <span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>

        <span class="n">ncol</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">nrow</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>

        <span class="n">col</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Create header from column names</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

        <span class="c1"># Get list of values from dataframe</span>
        <span class="n">statistics</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="n">colors</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;angel_awards&quot;</span><span class="p">:</span> <span class="s2">&quot;#B87333&quot;</span><span class="p">,</span>
            <span class="s2">&quot;angel_resq_awards&quot;</span><span class="p">:</span> <span class="s2">&quot;#341885&quot;</span><span class="p">,</span>
            <span class="s2">&quot;columns&quot;</span><span class="p">:</span> <span class="s2">&quot;#3378B8&quot;</span><span class="p">,</span>
            <span class="s2">&quot;green&quot;</span><span class="p">:</span> <span class="s2">&quot;#A1CCA1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;orange&quot;</span><span class="p">:</span> <span class="s2">&quot;#DF7401&quot;</span><span class="p">,</span>
            <span class="s2">&quot;gold&quot;</span><span class="p">:</span> <span class="s2">&quot;#FFDF00&quot;</span><span class="p">,</span>
            <span class="s2">&quot;platinum&quot;</span><span class="p">:</span> <span class="s2">&quot;#c0c0c0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;black&quot;</span><span class="p">:</span> <span class="s2">&quot;#ffffff&quot;</span><span class="p">,</span>
            <span class="s2">&quot;red&quot;</span><span class="p">:</span> <span class="s2">&quot;#F45D5D&quot;</span>
        <span class="p">}</span>

        <span class="n">awards</span> <span class="o">=</span> <span class="n">workbook1</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span>
            <span class="s1">&#39;bold&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;border&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;align&#39;</span><span class="p">:</span> <span class="s1">&#39;center&#39;</span><span class="p">,</span>
            <span class="s1">&#39;valign&#39;</span><span class="p">:</span> <span class="s1">&#39;vcenter&#39;</span><span class="p">,</span>
            <span class="s1">&#39;fg_color&#39;</span><span class="p">:</span> <span class="n">colors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;angel_awards&quot;</span><span class="p">)})</span>

        <span class="n">awards_color</span> <span class="o">=</span> <span class="n">workbook1</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span>
            <span class="s1">&#39;fg_color&#39;</span><span class="p">:</span> <span class="n">colors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;angel_awards&quot;</span><span class="p">)})</span>

        <span class="c1"># Convert row into letter convention</span>
        <span class="n">first_cell</span> <span class="o">=</span> <span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">last_cell</span> <span class="o">=</span> <span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncol</span><span class="p">)</span>
        <span class="n">worksheet</span><span class="o">.</span><span class="n">merge_range</span><span class="p">(</span><span class="n">first_cell</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">last_cell</span><span class="p">,</span> <span class="s1">&#39;ESO ANGELS AWARDS&#39;</span><span class="p">,</span> <span class="n">awards</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncol</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="n">xl_rowcol_to_cell</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">awards_color</span><span class="p">)</span>
       
        <span class="c1"># format for green color</span>
        <span class="n">green</span> <span class="o">=</span> <span class="n">workbook1</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span>
            <span class="s1">&#39;bold&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">&#39;align&#39;</span><span class="p">:</span> <span class="s1">&#39;center&#39;</span><span class="p">,</span>
            <span class="s1">&#39;valign&#39;</span><span class="p">:</span> <span class="s1">&#39;vcenter&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bg_color&#39;</span><span class="p">:</span> <span class="n">colors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;green&quot;</span><span class="p">)})</span>

        <span class="c1"># format for gold color</span>
        <span class="n">gold</span> <span class="o">=</span> <span class="n">workbook1</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span>
            <span class="s1">&#39;bold&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;align&#39;</span><span class="p">:</span> <span class="s1">&#39;center&#39;</span><span class="p">,</span>
            <span class="s1">&#39;valign&#39;</span><span class="p">:</span> <span class="s1">&#39;vcenter&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bg_color&#39;</span><span class="p">:</span> <span class="n">colors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gold&quot;</span><span class="p">)})</span>

        <span class="c1"># format for platinum color</span>
        <span class="n">plat</span> <span class="o">=</span> <span class="n">workbook1</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span>
            <span class="s1">&#39;bold&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;align&#39;</span><span class="p">:</span> <span class="s1">&#39;center&#39;</span><span class="p">,</span>
            <span class="s1">&#39;valign&#39;</span><span class="p">:</span> <span class="s1">&#39;vcenter&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bg_color&#39;</span><span class="p">:</span> <span class="n">colors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;platinum&quot;</span><span class="p">)})</span>

        <span class="c1"># format for gold black</span>
        <span class="n">black</span> <span class="o">=</span> <span class="n">workbook1</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span>
            <span class="s1">&#39;bold&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;align&#39;</span><span class="p">:</span> <span class="s1">&#39;center&#39;</span><span class="p">,</span>
            <span class="s1">&#39;valign&#39;</span><span class="p">:</span> <span class="s1">&#39;vcenter&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bg_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#000000&#39;</span><span class="p">,</span>
            <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="n">colors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;black&quot;</span><span class="p">)})</span>

        <span class="c1"># format for red color</span>
        <span class="n">red</span> <span class="o">=</span> <span class="n">workbook1</span><span class="o">.</span><span class="n">add_format</span><span class="p">({</span>
            <span class="s1">&#39;bold&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;align&#39;</span><span class="p">:</span> <span class="s1">&#39;center&#39;</span><span class="p">,</span>
            <span class="s1">&#39;valign&#39;</span><span class="p">:</span> <span class="s1">&#39;vcenter&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bg_color&#39;</span><span class="p">:</span> <span class="n">colors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;red&quot;</span><span class="p">)})</span>


        <span class="c1"># add table into worksheet</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">statistics</span><span class="p">,</span>
                   <span class="s1">&#39;header_row&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                   <span class="s1">&#39;columns&#39;</span><span class="p">:</span> <span class="n">col</span><span class="p">,</span>
                   <span class="s1">&#39;style&#39;</span><span class="p">:</span> <span class="s1">&#39;Table Style Light 8&#39;</span>
                   <span class="p">}</span>

        <span class="n">worksheet</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>

        <span class="n">number_of_rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">statistics</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>

        <span class="n">column_names</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="n">columns_to_be_hidden</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;# total patients&#39;</span><span class="p">,</span> <span class="s1">&#39;# patients treated with door to thrombolysis &lt; 60 minutes&#39;</span><span class="p">,</span> <span class="s1">&#39;# patients treated with door to thrombolysis &lt; 45 minutes&#39;</span><span class="p">,</span> <span class="s1">&#39;# patients treated with door to thrombectomy &lt; 90 minutes&#39;</span><span class="p">,</span> <span class="s1">&#39;# patients treated with door to thrombectomy &lt; 60 minutes&#39;</span><span class="p">,</span> <span class="s1">&#39;# recanalization rate out of total ischemic incidence&#39;</span><span class="p">,</span> <span class="s1">&#39;# suspected stroke patients undergoing CT/MRI&#39;</span><span class="p">,</span> <span class="s1">&#39;# all stroke patients undergoing dysphagia screening&#39;</span><span class="p">,</span> <span class="s1">&#39;# ischemic stroke patients discharged with antiplatelets&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">% i</span><span class="s1">schemic stroke patients discharged with antiplatelets&#39;</span><span class="p">,</span> <span class="s1">&#39;# ischemic stroke patients discharged home with antiplatelets&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">% i</span><span class="s1">schemic stroke patients discharged home with antiplatelets&#39;</span><span class="p">,</span> <span class="s1">&#39;# ischemic stroke patients discharged (home) with antiplatelets&#39;</span><span class="p">,</span> <span class="s1">&#39;# afib patients discharged with anticoagulants&#39;</span><span class="p">,</span> <span class="s1">&#39;% afib patients discharged with anticoagulants&#39;</span><span class="p">,</span> <span class="s1">&#39;# afib patients discharged home with anticoagulants&#39;</span><span class="p">,</span> <span class="s1">&#39;% afib patients discharged home with anticoagulants&#39;</span><span class="p">,</span> <span class="s1">&#39;# afib patients discharged (home) with anticoagulants&#39;</span><span class="p">,</span> <span class="s1">&#39;# stroke patients treated in a dedicated stroke unit / ICU&#39;</span><span class="p">]</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">columns_to_be_hidden</span><span class="p">:</span>
            <span class="c1"># Get index from column names and convert this index into Excel column</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">column_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">column</span> <span class="o">=</span> <span class="n">xl_col_to_name</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="n">column</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">column</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;hidden&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>

        <span class="n">row</span> <span class="o">=</span> <span class="mi">4</span>

        <span class="c1"># Format total patients (TRUE = green color)</span>
        <span class="k">while</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">nrow</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">column_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;Total Patients&#39;</span><span class="p">)</span>
            <span class="n">cell_n</span> <span class="o">=</span> <span class="n">xl_col_to_name</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="n">worksheet</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="n">cell_n</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;criteria&#39;</span><span class="p">:</span> <span class="s1">&#39;containing&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;TRUE&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="n">green</span><span class="p">})</span>
            <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">def</span> <span class="nf">angels_awards_ivt_60</span><span class="p">(</span><span class="n">column_name</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; The function adding format conditions for recanalization treatment (thrombolysis &lt; 60, thrombectomy &lt; 90)!</span>
<span class="sd">            </span>
<span class="sd">            :param column_name: the column name (eg. A)</span>
<span class="sd">            :type column_name: str</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">row</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="k">while</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">number_of_rows</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">cell_n</span> <span class="o">=</span> <span class="n">column_name</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="n">worksheet</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="n">cell_n</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;cell&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;criteria&#39;</span><span class="p">:</span> <span class="s1">&#39;between&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;minimum&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
                                                    <span class="s1">&#39;maximum&#39;</span><span class="p">:</span> <span class="mf">74.99</span><span class="p">,</span>
                                                    <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="n">gold</span><span class="p">})</span>
                <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">row</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="k">while</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">number_of_rows</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">cell_n</span> <span class="o">=</span> <span class="n">column_name</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="n">worksheet</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="n">cell_n</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;cell&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;criteria&#39;</span><span class="p">:</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">75</span><span class="p">,</span>
                                                    <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="n">black</span><span class="p">})</span>
                <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">index</span> <span class="o">=</span> <span class="n">column_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;% patients treated with door to thrombolysis &lt; 60 minutes&#39;</span><span class="p">)</span>
        <span class="n">angels_awards_ivt_60</span><span class="p">(</span><span class="n">column_name</span><span class="o">=</span><span class="n">xl_col_to_name</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>

        <span class="n">index</span> <span class="o">=</span> <span class="n">column_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;% patients treated with door to thrombectomy &lt; 90 minutes&#39;</span><span class="p">)</span>
        <span class="n">angels_awards_ivt_60</span><span class="p">(</span><span class="n">column_name</span><span class="o">=</span><span class="n">xl_col_to_name</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>


        <span class="k">def</span> <span class="nf">angels_awards_ivt_45</span><span class="p">(</span><span class="n">column_name</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; The function adding format conditions for recanalization treatment (thrombolysis &lt; 45, thrombectomy &lt; 60)!</span>
<span class="sd">            </span>
<span class="sd">            :param column_name: the column name (eg. A)</span>
<span class="sd">            :type column_name: str</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="n">row</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="k">while</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">number_of_rows</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">cell_n</span> <span class="o">=</span> <span class="n">column_name</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="n">worksheet</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="n">cell_n</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;cell&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;criteria&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mf">49.99</span><span class="p">,</span>
                                                    <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="n">plat</span><span class="p">})</span>
                <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">row</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="k">while</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">number_of_rows</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">cell_n</span> <span class="o">=</span> <span class="n">column_name</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="n">worksheet</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="n">cell_n</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;cell&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;criteria&#39;</span><span class="p">:</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
                                                    <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="n">black</span><span class="p">})</span>
                <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">index</span> <span class="o">=</span> <span class="n">column_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;% patients treated with door to thrombolysis &lt; 45 minutes&#39;</span><span class="p">)</span>
        <span class="n">angels_awards_ivt_45</span><span class="p">(</span><span class="n">column_name</span><span class="o">=</span><span class="n">xl_col_to_name</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>

        <span class="n">index</span> <span class="o">=</span> <span class="n">column_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;% patients treated with door to thrombectomy &lt; 60 minutes&#39;</span><span class="p">)</span>
        <span class="n">angels_awards_ivt_45</span><span class="p">(</span><span class="n">column_name</span><span class="o">=</span><span class="n">xl_col_to_name</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">angels_awards_recan</span><span class="p">(</span><span class="n">column_name</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; The function adding format conditions for recanalization rate!</span>
<span class="sd">            </span>
<span class="sd">            :param column_name: the column name (eg. A)</span>
<span class="sd">            :type column_name: str</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">row</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="k">while</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">number_of_rows</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">cell_n</span> <span class="o">=</span> <span class="n">column_name</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="n">worksheet</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="n">cell_n</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;cell&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;criteria&#39;</span><span class="p">:</span> <span class="s1">&#39;between&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;minimum&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                                                    <span class="s1">&#39;maximum&#39;</span><span class="p">:</span> <span class="mf">14.99</span><span class="p">,</span>
                                                    <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="n">gold</span><span class="p">})</span>
                <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">row</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="k">while</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">number_of_rows</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">cell_n</span> <span class="o">=</span> <span class="n">column_name</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="n">worksheet</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="n">cell_n</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;cell&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;criteria&#39;</span><span class="p">:</span> <span class="s1">&#39;between&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;minimum&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
                                                    <span class="s1">&#39;maximum&#39;</span><span class="p">:</span> <span class="mf">24.99</span><span class="p">,</span>
                                                    <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="n">plat</span><span class="p">})</span>
                <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">row</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="k">while</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">number_of_rows</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">cell_n</span> <span class="o">=</span> <span class="n">column_name</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="n">worksheet</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="n">cell_n</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;cell&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;criteria&#39;</span><span class="p">:</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span>
                                                    <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="n">black</span><span class="p">})</span>
                <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">index</span> <span class="o">=</span> <span class="n">column_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">% r</span><span class="s1">ecanalization rate out of total ischemic incidence&#39;</span><span class="p">)</span>
        <span class="n">angels_awards_recan</span><span class="p">(</span><span class="n">column_name</span><span class="o">=</span><span class="n">xl_col_to_name</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>


        <span class="k">def</span> <span class="nf">angels_awards_processes</span><span class="p">(</span><span class="n">column_name</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; The function adding format conditions for values which have GOLD in interval &lt;80, 85), PLATINUM in interval &lt;85, 90) and DIAMOND in interval &lt;90,100&gt;!</span>
<span class="sd">            </span>
<span class="sd">            :param column_name: the column name (eg. A)</span>
<span class="sd">            :type column_name: str</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">count</span> <span class="o">=</span> <span class="n">count</span>
            <span class="n">row</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="k">while</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">number_of_rows</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">cell_n</span> <span class="o">=</span> <span class="n">column_name</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="n">worksheet</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="n">cell_n</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;cell&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;criteria&#39;</span><span class="p">:</span> <span class="s1">&#39;between&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;minimum&#39;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>
                                                    <span class="s1">&#39;maximum&#39;</span><span class="p">:</span> <span class="mf">84.99</span><span class="p">,</span>
                                                    <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="n">gold</span><span class="p">})</span>

                <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">row</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="k">while</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">number_of_rows</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">cell_n</span> <span class="o">=</span> <span class="n">column_name</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="n">worksheet</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="n">cell_n</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;cell&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;criteria&#39;</span><span class="p">:</span> <span class="s1">&#39;between&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;minimum&#39;</span><span class="p">:</span> <span class="mi">85</span><span class="p">,</span>
                                                    <span class="s1">&#39;maximum&#39;</span><span class="p">:</span> <span class="mf">89.99</span><span class="p">,</span>
                                                    <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="n">plat</span><span class="p">})</span>
                <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">row</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="k">while</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">number_of_rows</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">cell_n</span> <span class="o">=</span> <span class="n">column_name</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="n">worksheet</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="n">cell_n</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;cell&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;criteria&#39;</span><span class="p">:</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">90</span><span class="p">,</span>
                                                    <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="n">black</span><span class="p">})</span>
                <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">index</span> <span class="o">=</span> <span class="n">column_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">% s</span><span class="s1">uspected stroke patients undergoing CT/MRI&#39;</span><span class="p">)</span>
        <span class="n">angels_awards_processes</span><span class="p">(</span><span class="n">column_name</span><span class="o">=</span><span class="n">xl_col_to_name</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">column_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;% all stroke patients undergoing dysphagia screening&#39;</span><span class="p">)</span>
        <span class="n">angels_awards_processes</span><span class="p">(</span><span class="n">column_name</span><span class="o">=</span><span class="n">xl_col_to_name</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">column_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">% i</span><span class="s1">schemic stroke patients discharged (home) with antiplatelets&#39;</span><span class="p">)</span>
        <span class="n">angels_awards_processes</span><span class="p">(</span><span class="n">column_name</span><span class="o">=</span><span class="n">xl_col_to_name</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">column_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;% afib patients discharged (home) with anticoagulants&#39;</span><span class="p">)</span>
        <span class="n">angels_awards_processes</span><span class="p">(</span><span class="n">column_name</span><span class="o">=</span><span class="n">xl_col_to_name</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>

        <span class="c1"># setting colors of cells according to their values</span>
        <span class="k">def</span> <span class="nf">angels_awards_hosp</span><span class="p">(</span><span class="n">column_name</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; The function adding format conditions for hospitalized in the stroke unit/ICU!</span>
<span class="sd">            </span>
<span class="sd">            :param column_name: the column name (eg. A)</span>
<span class="sd">            :type column_name: str</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">row</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="k">while</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">number_of_rows</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">cell_n</span> <span class="o">=</span> <span class="n">column_name</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="n">worksheet</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="n">cell_n</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;cell&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;criteria&#39;</span><span class="p">:</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                                    <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="n">plat</span><span class="p">})</span>
                <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">row</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="k">while</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">number_of_rows</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">cell_n</span> <span class="o">=</span> <span class="n">column_name</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="n">worksheet</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="n">cell_n</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;cell&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;criteria&#39;</span><span class="p">:</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mf">0.99</span><span class="p">,</span>
                                                    <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="n">black</span><span class="p">})</span>
                <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>

        
        <span class="n">index</span> <span class="o">=</span> <span class="n">column_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">% s</span><span class="s1">troke patients treated in a dedicated stroke unit / ICU&#39;</span><span class="p">)</span>
        <span class="n">angels_awards_hosp</span><span class="p">(</span><span class="n">column_name</span><span class="o">=</span><span class="n">xl_col_to_name</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">proposed_award</span><span class="p">(</span><span class="n">column_name</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; The function adding format conditions for the proposed award!</span>
<span class="sd">            </span>
<span class="sd">            :param column_name: the column name (eg. A)</span>
<span class="sd">            :type column_name: str</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">row</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="k">while</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">nrow</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">cell_n</span> <span class="o">=</span> <span class="n">column</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="n">worksheet</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="n">cell_n</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;criteria&#39;</span><span class="p">:</span> <span class="s1">&#39;containing&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;NONE&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="n">green</span><span class="p">})</span>
                <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">row</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="k">while</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">nrow</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">cell_n</span> <span class="o">=</span> <span class="n">column</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="n">worksheet</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="n">cell_n</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;criteria&#39;</span><span class="p">:</span> <span class="s1">&#39;containing&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;GOLD&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="n">gold</span><span class="p">})</span>
                <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">row</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="k">while</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">nrow</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">cell_n</span> <span class="o">=</span> <span class="n">column</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="n">worksheet</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="n">cell_n</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;criteria&#39;</span><span class="p">:</span> <span class="s1">&#39;containing&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;PLATINUM&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="n">plat</span><span class="p">})</span>
                <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">row</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="k">while</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">nrow</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">cell_n</span> <span class="o">=</span> <span class="n">column</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="n">worksheet</span><span class="o">.</span><span class="n">conditional_format</span><span class="p">(</span><span class="n">cell_n</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;criteria&#39;</span><span class="p">:</span> <span class="s1">&#39;containing&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;DIAMOND&#39;</span><span class="p">,</span>
                                                    <span class="s1">&#39;format&#39;</span><span class="p">:</span> <span class="n">black</span><span class="p">})</span>
                <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">index</span> <span class="o">=</span> <span class="n">column_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;Proposed Award&#39;</span><span class="p">)</span>
        <span class="n">proposed_award</span><span class="p">(</span><span class="n">column_name</span><span class="o">=</span><span class="n">xl_col_to_name</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>

        <span class="n">workbook1</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="GeneratePreprocessedData"><a class="viewcode-back" href="../../source/resqdb.html#resqdb.Atalaia.GeneratePreprocessedData">[docs]</a><span class="k">class</span> <span class="nc">GeneratePreprocessedData</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; Class generating preprocessed data in the excel format containing calculated statistics with intermediate columns! </span>
<span class="sd">    </span>
<span class="sd">    :param df: the dataframe with calculated statistics</span>
<span class="sd">    :type df: dataframe</span>
<span class="sd">    :param path: the path where the output file should be saved</span>
<span class="sd">    :type path: str</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>

        <span class="n">debug</span> <span class="o">=</span> <span class="s1">&#39;debug_&#39;</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-%m-%Y&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.log&#39;</span> 
        <span class="n">log_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">debug</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">log_file</span><span class="p">,</span>
                            <span class="n">filemode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span>
                            <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1">,</span><span class="si">%(msecs)d</span><span class="s1"> </span><span class="si">%(name)s</span><span class="s1"> </span><span class="si">%(levelname)s</span><span class="s1"> </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
                            <span class="n">datefmt</span><span class="o">=</span><span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">,</span>
                            <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Running GeneratePreprocessedData&#39;</span><span class="p">)</span> 

        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">generate_preprocessed_data</span><span class="p">()</span>

<div class="viewcode-block" id="GeneratePreprocessedData.generate_preprocessed_data"><a class="viewcode-back" href="../../source/resqdb.html#resqdb.Atalaia.GeneratePreprocessedData.generate_preprocessed_data">[docs]</a>    <span class="k">def</span> <span class="nf">generate_preprocessed_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The function creating workbook and sheet with preprocessed data! &quot;&quot;&quot;</span>
        <span class="c1"># Convert dates and timestamps into string</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;visit_date_es&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;visit_date_es&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;hospital_date_es&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;hospital_date_es&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;discharge_date_es&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;discharge_date_es&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;hospital_date_fixed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;hospital_date_fixed&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;discharge_date_fixed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;discharge_date_fixed&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;visit_timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;visit_timestamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;hospital_timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;hospital_timestamp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

        <span class="c1"># Get list of values</span>
        <span class="n">preprocessed_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="n">workbook</span> <span class="o">=</span> <span class="n">xlsxwriter</span><span class="o">.</span><span class="n">Workbook</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="n">sheet</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_worksheet</span><span class="p">(</span><span class="s1">&#39;Preprocessed_raw_data&#39;</span><span class="p">)</span>

        <span class="c1"># Set width of columns</span>
        <span class="n">sheet</span><span class="o">.</span><span class="n">set_column</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>

        <span class="n">ncol</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">nrow</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
        
        <span class="c1"># Create headers</span>
        <span class="n">col</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

        <span class="c1"># Set data</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">preprocessed_data</span><span class="p">,</span>
                   <span class="s1">&#39;header_row&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                   <span class="s1">&#39;columns&#39;</span><span class="p">:</span> <span class="n">col</span><span class="p">,</span>
                   <span class="s1">&#39;style&#39;</span><span class="p">:</span> <span class="s1">&#39;Table Style Light 1&#39;</span>
                   <span class="p">}</span>
        <span class="c1"># Create table</span>
        <span class="n">sheet</span><span class="o">.</span><span class="n">add_table</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>

        <span class="n">workbook</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">RES-Q package</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Marie Jankujova.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.11</a>
      
    </div>

    

    
  </body>
</html>